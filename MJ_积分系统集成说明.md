# Midjourney积分系统集成说明

## 🎯 重要变更

**Midjourney积分系统已与Open WebUI统一积分系统完全集成！**

## ✅ 集成优势

### 1. **统一积分管理**

- ✅ 使用Open WebUI现有的`credit`和`credit_log`表
- ✅ 管理员可在统一界面管理所有用户积分
- ✅ 用户在一个地方查看所有积分消费记录

### 2. **完整的积分生态**

- ✅ 支持充值卡、支付接口等现有积分来源
- ✅ 统一的积分汇率和计费规则
- ✅ 完整的积分历史和审计日志

### 3. **系统一致性**

- ✅ 与聊天、图像生成等其他功能使用相同积分
- ✅ 统一的权限控制和用户体验
- ✅ 避免多套积分系统的复杂性

## 🔧 技术实现

### 积分函数映射

```python
# 原MJCredit -> 现在使用系统Credits
get_user_credit_balance(user_id)    # 使用 Credits.get_credit_by_user_id()
deduct_user_credits(user_id, amount, reason, task_id)  # 使用 Credits.add_credit_by_user_id()
add_user_credits(user_id, amount, reason, task_id)     # 使用 Credits.add_credit_by_user_id()
```

### 积分记录格式

```json
{
	"desc": "Midjourney: MJ imagine task",
	"api_params": { "task_id": "12345" },
	"usage": { "service": "midjourney", "credits": 10 }
}
```

## 📊 积分消费示例

### Midjourney任务扣费

- **Fast模式**: 5积分/次
- **Turbo模式**: 10积分/次
- **Relax模式**: 2积分/次

### 积分记录追踪

- ✅ 每次MJ任务自动扣费
- ✅ 任务失败自动退款
- ✅ 管理员可查看详细消费记录
- ✅ 用户可在积分页面查看MJ消费历史

## 🚀 管理员功能

### 用户积分管理

- ✅ 搜索用户并查看积分余额
- ✅ 给用户充值/扣除积分
- ✅ 查看用户积分消费历史
- ✅ 批量操作多个用户

### 系统统计

- ✅ MJ任务总数和成功率
- ✅ 各模式使用统计
- ✅ 积分消费统计

## 💡 用户体验

### 前端界面

- ✅ 实时显示积分余额
- ✅ 生成前验证积分是否充足
- ✅ 任务完成后实时更新余额
- ✅ 统一的积分充值入口

### API兼容性

- ✅ 保持原有MJ API接口不变
- ✅ 积分查询API：`/api/v1/midjourney/credits`
- ✅ 向后兼容所有前端调用

## 🔒 安全保障

### 积分安全

- ✅ 原子性扣费操作，避免重复扣费
- ✅ 任务失败自动退款机制
- ✅ 完整的积分审计日志
- ✅ 管理员操作记录追踪

### 数据一致性

- ✅ 使用数据库事务保证一致性
- ✅ 积分余额实时同步
- ✅ 错误恢复机制

## 📈 未来扩展

### 可扩展性

- 🔄 可轻松添加新的AI服务积分消费
- 🔄 支持更复杂的计费规则（如会员折扣）
- 🔄 支持积分套餐和促销活动
- 🔄 支持积分分享和转账功能

## 🎉 总结

通过与Open WebUI统一积分系统的集成，Midjourney功能现在享有：

1. **统一管理** - 一套积分系统管理所有AI服务
2. **完整生态** - 复用现有的充值、支付、管理功能
3. **用户友好** - 简化的积分体验和统一界面
4. **安全可靠** - 成熟的积分安全机制
5. **易于扩展** - 为未来更多AI服务奠定基础

**Midjourney已完全集成到Open WebUI生态系统中，可直接投入生产使用！** 🚀
