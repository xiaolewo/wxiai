# DreamWork å›¾ç”Ÿå›¾ 500/400 é”™è¯¯å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æ€»ç»“

ç”¨æˆ·åé¦ˆDreamWorkå›¾ç”Ÿå›¾åŠŸèƒ½æŒç»­æŠ¥é”™ï¼š

- å‰ç«¯æ˜¾ç¤ºï¼š`POST http://localhost:8080/api/v1/dreamwork/submit/image-to-image 500 (Internal Server Error)`
- åç«¯é”™è¯¯ï¼š`DreamWork APIé”™è¯¯: æäº¤ä»»åŠ¡å¤±è´¥ï¼Œè¿”å› code: 0`

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±åº¦è¯Šæ–­å‘ç°ï¼Œé—®é¢˜æ ¹æºæ˜¯ï¼š

1. **APIæ ¼å¼è¦æ±‚é”™è¯¯ç†è§£**ï¼šDreamWork APIçš„å›¾ç”Ÿå›¾æ¥å£è¦æ±‚çš„æ˜¯**å®Œæ•´çš„data URLæ ¼å¼**ï¼Œè€Œä¸æ˜¯è£¸éœ²çš„base64æ•°æ®
2. **å›¾ç‰‡å¤§å°é™åˆ¶**ï¼šAPIæ‹’ç»è¿‡å°çš„å›¾ç‰‡ï¼ˆå¦‚1x1åƒç´ çš„æµ‹è¯•å›¾ç‰‡ï¼‰
3. **data URLæ ¼å¼ç¼ºå¤±**ï¼šåŸä»£ç é”™è¯¯åœ°ç§»é™¤äº†`data:image/png;base64,`å‰ç¼€

### å…³é”®é”™è¯¯ä¿¡æ¯è§£è¯»ï¼š

```
"Image Decode Error: image format unsupported: invalid image url.
err=Get \"iVBORw0KGg...\": unsupported protocol scheme \"\""
```

è¿™è¡¨æ˜APIå°†base64æ•°æ®è¯¯è®¤ä¸ºURLï¼Œå¯¼è‡´åè®®è§£æå¤±è´¥ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤æ ¸å¿ƒæ–‡ä»¶ï¼š`open_webui/utils/dreamwork_fixed.py`

**å…³é”®ä¿®å¤ç‚¹ï¼š**

```python
# âŒ é”™è¯¯åšæ³•ï¼šç§»é™¤data URLå‰ç¼€
if image_data.startswith('data:'):
    image_data = image_data.split(',')[1]  # ç§»é™¤å‰ç¼€

# âœ… æ­£ç¡®åšæ³•ï¼šä¿æŒå®Œæ•´data URLæ ¼å¼
if image_data.startswith('data:'):
    data_url = image_data  # ä¿æŒå®Œæ•´æ ¼å¼
else:
    # ä¸ºçº¯base64æ•°æ®æ·»åŠ æ­£ç¡®çš„å‰ç¼€
    data_url = f"data:image/{image_format};base64,{clean_image_data}"
```

### 2. å®Œæ•´çš„ä¿®å¤å‡½æ•°ï¼š

```python
async def generate_image_to_image_fixed(config, request) -> dict:
    """ä¿®å¤ç‰ˆå›¾ç”Ÿå›¾å‡½æ•° - è§£å†³APIéœ€è¦å®Œæ•´data URLæ ¼å¼çš„é—®é¢˜"""

    # ç¡®ä¿æ˜¯å®Œæ•´çš„data URLæ ¼å¼
    if image_data.startswith('data:'):
        data_url = image_data  # ä¿æŒå®Œæ•´æ ¼å¼
    else:
        # æ£€æµ‹å›¾ç‰‡æ ¼å¼å¹¶æ„å»ºæ­£ç¡®çš„data URL
        decoded = base64.b64decode(clean_image_data)
        image_format = detect_image_format(decoded)
        data_url = f"data:image/{image_format};base64,{clean_image_data}"

    # ä½¿ç”¨å®Œæ•´çš„data URLè°ƒç”¨API
    request_data = {
        "model": "doubao-seededit-3-0-i2i-250628",
        "prompt": request.prompt.strip(),
        "image": data_url  # å…³é”®ï¼šä½¿ç”¨å®Œæ•´çš„data URL
    }
```

## ğŸ§ª éªŒè¯ç»“æœ

### æµ‹è¯•å‰ï¼ˆå¤±è´¥ï¼‰ï¼š

```
çŠ¶æ€ç : 500
é”™è¯¯: {"code": 0, "msg": "æäº¤ä»»åŠ¡å¤±è´¥"}
```

### æµ‹è¯•åï¼ˆæˆåŠŸï¼‰ï¼š

```
ğŸ¨ ã€DreamWorkä¿®å¤ç‰ˆã€‘å“åº”çŠ¶æ€: 200
âœ… ä¿®å¤æˆåŠŸ! APIè¿”å›:
   æ¨¡å‹: doubao-seededit-3-0-i2i-250628
   å›¾ç‰‡æ•°é‡: 1
   å›¾ç‰‡URL: https://p3-aiop-sign.byteimg.com/tos-cn-i-vuqhorh5...
```

## ğŸ“‹ å®Œæ•´ä¿®å¤æ¸…å•

âœ… **æ•°æ®åº“ä¿®å¤**ï¼šæ·»åŠ ç¼ºå¤±çš„è¡¨åˆ—ï¼ˆprogress, input_image, propertiesï¼‰
âœ… **æ ‡ç­¾ä¿®å¤**ï¼šä¿®å¤DreamWorkä»»åŠ¡æ˜¾ç¤º"MidJourney"æ ‡ç­¾çš„é—®é¢˜
âœ… **å†å²åŠ è½½ä¿®å¤**ï¼šä¿®å¤DreamWorkå›¾ç‰‡åˆ·æ–°åæ¶ˆå¤±çš„é—®é¢˜
âœ… **APIæ ¼å¼ä¿®å¤**ï¼šä¿®å¤å›¾ç”Ÿå›¾APIè°ƒç”¨çš„data URLæ ¼å¼é—®é¢˜
âœ… **å›¾ç‰‡å¤§å°ä¿®å¤**ï¼šç¡®ä¿APIæ¥æ”¶è¶³å¤Ÿå¤§å°çš„å›¾ç‰‡æ•°æ®

## ğŸš€ éƒ¨ç½²è¯´æ˜

ä¿®å¤å·²ç»å®Œæˆå¹¶éªŒè¯æœ‰æ•ˆã€‚å½“å‰çš„å®ç°ï¼š

1. **è·¯ç”±å±‚**ï¼š`open_webui/routers/dreamwork.py` è°ƒç”¨ä¿®å¤ç‰ˆå‡½æ•°
2. **æ ¸å¿ƒä¿®å¤**ï¼š`open_webui/utils/dreamwork_fixed.py` åŒ…å«æ­£ç¡®çš„APIè°ƒç”¨
3. **å‰ç«¯å…¼å®¹**ï¼šä¿æŒç°æœ‰å‰ç«¯æ¥å£ä¸å˜

## ğŸ‰ æœ€ç»ˆçŠ¶æ€

- âœ… æ–‡ç”Ÿå›¾åŠŸèƒ½ï¼šæ­£å¸¸å·¥ä½œ
- âœ… å›¾ç”Ÿå›¾åŠŸèƒ½ï¼š**å·²ä¿®å¤ï¼Œæ­£å¸¸å·¥ä½œ**
- âœ… ä»»åŠ¡å†å²ï¼šæ­£ç¡®ä¿å­˜å’Œæ˜¾ç¤º
- âœ… ç§¯åˆ†ç®¡ç†ï¼šæ­£å¸¸æ‰£è´¹å’Œé€€è´¹
- âœ… æœåŠ¡è¯†åˆ«ï¼šæ­£ç¡®æ˜¾ç¤º"å³æ¢¦ (DreamWork)"æ ‡ç­¾

## ğŸ“ æŠ€æœ¯è¦ç‚¹æ€»ç»“

1. **data URLæ ¼å¼é‡è¦æ€§**ï¼šå›¾ç‰‡å¿…é¡»ä»¥`data:image/æ ¼å¼;base64,æ•°æ®`çš„å®Œæ•´æ ¼å¼å‘é€
2. **å›¾ç‰‡å¤§å°é™åˆ¶**ï¼šé¿å…ä½¿ç”¨è¿‡å°çš„æµ‹è¯•å›¾ç‰‡ï¼Œå»ºè®®æœ€å°100x100åƒç´ 
3. **é”™è¯¯è¯Šæ–­æŠ€å·§**ï¼šé€šè¿‡APIé”™è¯¯ä¿¡æ¯"unsupported protocol scheme"è¯†åˆ«æ ¼å¼é—®é¢˜
4. **å…¼å®¹æ€§è®¾è®¡**ï¼šä¿®å¤å‡½æ•°è‡ªåŠ¨æ£€æµ‹è¾“å…¥æ ¼å¼å¹¶è½¬æ¢ä¸ºæ­£ç¡®æ ¼å¼

**ä¿®å¤æ—¶é—´**ï¼š2025-08-17
**ä¿®å¤çŠ¶æ€**ï¼šå®Œæˆ âœ…
**éªŒè¯çŠ¶æ€**ï¼šé€šè¿‡ âœ…
