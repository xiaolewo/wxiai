# æ•°æ®åº“è¿ç§»ç³»ç»Ÿè¯¦ç»†è¯´æ˜

## ğŸ—ï¸ é¡¹ç›®æ¶æ„æ¦‚è¿°

**wxiai-main** æ˜¯ä¸€ä¸ªåŸºäºFastAPI + SQLAlchemy + Alembicçš„AIæœåŠ¡é›†æˆå¹³å°ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- Flux AIå›¾åƒç”ŸæˆæœåŠ¡
- ç”¨æˆ·ç®¡ç†å’Œæƒé™æ§åˆ¶
- å·¥å…·ç®¡ç†ç³»ç»Ÿ
- ç§¯åˆ†å’Œæ”¯ä»˜ç³»ç»Ÿ
- å¤šç§AIæ¨¡å‹é›†æˆï¼ˆMidjourneyã€Klingã€Jimengç­‰ï¼‰

**æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š**

- Backend: FastAPI + SQLAlchemy + Alembic
- Frontend: SvelteKit
- Database: SQLite (ç”Ÿäº§ç¯å¢ƒå¯ç”¨PostgreSQL)
- Deployment: Docker + Docker Compose

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»ç³»ç»Ÿæ¶æ„

### 1. Alembicé…ç½®ç»“æ„

```
backend/
â”œâ”€â”€ open_webui/
â”‚   â”œâ”€â”€ migrations/          # Alembicè¿ç§»ç›®å½•
â”‚   â”‚   â”œâ”€â”€ env.py          # Alembicç¯å¢ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ alembic.ini     # Alembicé…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ versions/       # è¿ç§»ç‰ˆæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â””â”€â”€ db.py           # æ•°æ®åº“è¿æ¥å’ŒBaseå®šä¹‰
â”‚   â”œâ”€â”€ models/             # SQLAlchemyæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ users.py        # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ tools.py        # å·¥å…·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ flux.py         # Fluxé…ç½®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ config.py           # åº”ç”¨é…ç½®å’Œè¿ç§»æ‰§è¡Œé€»è¾‘
```

### 2. è¿ç§»æ‰§è¡Œæµç¨‹

**åº”ç”¨å¯åŠ¨æ—¶çš„è‡ªåŠ¨è¿ç§»æœºåˆ¶ï¼š**

```python
# config.py ä¸­çš„è¿ç§»æ‰§è¡Œé€»è¾‘
def run_migrations():
    """è¿è¡ŒAlembicè¿ç§»"""
    try:
        from alembic import command
        from alembic.config import Config

        alembic_cfg = Config(OPEN_WEBUI_DIR / "alembic.ini")
        migrations_path = OPEN_WEBUI_DIR / "migrations"
        alembic_cfg.set_main_option("script_location", str(migrations_path))

        # ä¸‰å±‚è¿ç§»ç­–ç•¥
        try:
            command.upgrade(alembic_cfg, "merge_heads_final")  # å°è¯•åˆå¹¶ç‚¹
        except Exception:
            try:
                command.upgrade(alembic_cfg, "heads")          # å°è¯•æ‰€æœ‰heads
            except Exception:
                command.upgrade(alembic_cfg, "head")           # æœ€åå°è¯•å•head

    except Exception as e:
        # Fallback: ç›´æ¥åˆ›å»ºè¡¨ç»“æ„
        from open_webui.internal.db import engine, Base
        Base.metadata.create_all(bind=engine)

def delayed_migration_execution():
    """å»¶è¿Ÿæ‰§è¡Œè¿ç§»ï¼Œé¿å…å¾ªç¯å¯¼å…¥"""
    def run_delayed():
        time.sleep(1)  # ç­‰å¾…å¯¼å…¥å®Œæˆ
        run_migrations()

    # é˜»å¡å¼æ‰§è¡Œï¼Œç¡®ä¿è¿ç§»å®Œæˆåå†å¯åŠ¨åº”ç”¨
    migration_thread = threading.Thread(target=run_delayed, daemon=False)
    migration_thread.start()
    migration_thread.join(timeout=30)  # æœ€å¤šç­‰å¾…30ç§’

# åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
delayed_migration_execution()
```

### 3. ä¸‰å±‚ä¿æŠ¤æœºåˆ¶

**ç¬¬ä¸€å±‚ï¼šAlembicè‡ªåŠ¨è¿ç§»**

- æ£€æµ‹æœªæ‰§è¡Œçš„è¿ç§»æ–‡ä»¶
- æŒ‰ç‰ˆæœ¬ä¾èµ–é¡ºåºæ‰§è¡Œ
- æ”¯æŒå‡çº§å’Œé™çº§æ“ä½œ

**ç¬¬äºŒå±‚ï¼šç›´æ¥åˆ›å»ºè¡¨ç»“æ„**

- å½“Alembicè¿ç§»å¤±è´¥æ—¶è§¦å‘
- ä½¿ç”¨SQLAlchemyçš„`create_all()`åˆ›å»ºæ‰€æœ‰è¡¨
- ç¡®ä¿åŸºæœ¬çš„è¡¨ç»“æ„å­˜åœ¨

**ç¬¬ä¸‰å±‚ï¼šè¿è¡Œæ—¶å…¼å®¹å¤„ç†**

- åœ¨æ¨¡å‹å±‚é¢å¤„ç†ç¼ºå¤±çš„åˆ—
- ORMæŸ¥è¯¢å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°åŸç”ŸSQL
- ä¸ºç¼ºå¤±å­—æ®µæä¾›é»˜è®¤å€¼

## ğŸ”§ å…³é”®è¿ç§»æ–‡ä»¶è¯´æ˜

### é‡è¦çš„è¿ç§»ç‰ˆæœ¬

```
migrations/versions/
â”œâ”€â”€ 70c7b727736e_add_tool_access_control_column.py    # å·¥å…·è®¿é—®æ§åˆ¶åˆ—
â”œâ”€â”€ ef6fab585ac1_add_user_phone_column.py             # ç”¨æˆ·æ‰‹æœºå·åˆ—
â”œâ”€â”€ 24e8f9a7b1c2_add_flux_model_credits_column.py     # Fluxæ¨¡å‹ç§¯åˆ†é…ç½®
â”œâ”€â”€ abc123def456_add_cloud_urls_to_all_tasks.py       # äº‘å­˜å‚¨URLåˆ—
â””â”€â”€ merge_heads_final.py                              # å¤šå¤´åˆå¹¶æ–‡ä»¶
```

### å…¸å‹è¿ç§»æ–‡ä»¶ç»“æ„

```python
"""add_user_phone_column

Revision ID: ef6fab585ac1
Revises: 70c7b727736e
Create Date: 2025-08-18 12:15:17.101992
"""

def upgrade() -> None:
    """å‡çº§æ“ä½œï¼šæ·»åŠ æ–°åˆ—"""
    connection = op.get_bind()
    inspector = sa.inspect(connection)

    if "user" in inspector.get_table_names():
        existing_columns = [col["name"] for col in inspector.get_columns("user")]

        with op.batch_alter_table("user", schema=None) as batch_op:
            if "phone" not in existing_columns:
                batch_op.add_column(sa.Column("phone", sa.String(), nullable=True))
                print("Added phone column to user table")
            else:
                print("phone column already exists in user table")

def downgrade() -> None:
    """é™çº§æ“ä½œï¼šåˆ é™¤åˆ—ï¼ˆç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼‰"""
    with op.batch_alter_table("user", schema=None) as batch_op:
        batch_op.drop_column("phone")
```

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨æœºåˆ¶

### 1. åªæ·»åŠ ä¸åˆ é™¤åŸåˆ™

**å®‰å…¨çš„è¿ç§»æ“ä½œï¼š**

```python
# âœ… å®‰å…¨ï¼šæ·»åŠ æ–°åˆ—
op.add_column('user', sa.Column('phone', sa.String(), nullable=True))

# âœ… å®‰å…¨ï¼šæ·»åŠ æ–°è¡¨
op.create_table('new_feature', ...)

# âœ… å®‰å…¨ï¼šæ·»åŠ ç´¢å¼•
op.create_index('ix_user_email', 'user', ['email'])
```

**ç¦æ­¢çš„å±é™©æ“ä½œï¼š**

```python
# âŒ å±é™©ï¼šåˆ é™¤è¡¨
# op.drop_table('user')

# âŒ å±é™©ï¼šåˆ é™¤åˆ—
# op.drop_column('user', 'email')

# âŒ å±é™©ï¼šä¿®æ”¹åˆ—ç±»å‹ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼‰
# op.alter_column('user', 'age', type_=sa.String())
```

### 2. å‘åå…¼å®¹å¤„ç†

æ¯ä¸ªæ¨¡å‹éƒ½å®ç°äº†å‘åå…¼å®¹æœºåˆ¶ï¼š

```python
# users.py ä¸­çš„å…¼å®¹å¤„ç†ç¤ºä¾‹
def get_users(self, filter=None, skip=None, limit=None):
    with get_db() as db:
        try:
            # å°è¯•æ­£å¸¸ORMæŸ¥è¯¢
            query = db.query(User)
            # ... æ­£å¸¸å¤„ç†é€»è¾‘
            users = query.all()
            return {"users": [UserModel.model_validate(user) for user in users]}

        except Exception as e:
            if "no such column" in str(e) and "phone" in str(e):
                # æ£€æµ‹åˆ°phoneåˆ—ç¼ºå¤±ï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼
                logger.warning("phoneåˆ—ä¸å­˜åœ¨ï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼æŸ¥è¯¢users")

                # ä½¿ç”¨åŸç”ŸSQLæŸ¥è¯¢ï¼Œè·³è¿‡ç¼ºå¤±çš„åˆ—
                result = db.execute(text("""
                    SELECT id, name, email, role, profile_image_url,
                           last_active_at, updated_at, created_at, api_key,
                           settings, info, oauth_sub
                    FROM user ORDER BY created_at DESC
                """)).fetchall()

                users = []
                for row in result:
                    user_dict = {
                        "id": row[0], "name": row[1], "email": row[2],
                        # ... å…¶ä»–å­—æ®µæ˜ å°„
                        "phone": None,  # ç¼ºå¤±å­—æ®µè®¾ä¸ºé»˜è®¤å€¼
                    }
                    users.append(UserModel.model_validate(user_dict))

                return {"users": users, "total": len(users)}
```

### 3. Sessionç®¡ç†æœ€ä½³å®è·µ

**æ­£ç¡®çš„Sessionä½¿ç”¨ï¼š**

```python
# âœ… æ­£ç¡®ï¼šåœ¨åŒä¸€ä¸ªSessionä¸­æ“ä½œ
with get_db() as db:
    config = db.query(FluxConfig).first()  # åœ¨å½“å‰Sessionä¸­æŸ¥è¯¢
    if config:
        config.api_key = new_key              # ç›´æ¥ä¿®æ”¹
        db.commit()                           # æäº¤æ›´æ”¹

# âŒ é”™è¯¯ï¼šè·¨Sessionæ“ä½œ
config = FluxConfigs.get_config()  # æ¥è‡ªå…¶ä»–Session
with get_db() as db:
    config.api_key = new_key        # ä¼šå¯¼è‡´Sessioné”™è¯¯
    db.commit()
```

## ğŸš€ éƒ¨ç½²åœºæ™¯å¤„ç†

### 1. å…¨æ–°éƒ¨ç½²ï¼ˆç©ºæ•°æ®åº“ï¼‰

```
å¯åŠ¨æµç¨‹ï¼š
1. æ£€æµ‹æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨
2. æ‰§è¡Œæ‰€æœ‰è¿ç§»æ–‡ä»¶ï¼ˆä»åˆå§‹ç‰ˆæœ¬åˆ°æœ€æ–°ï¼‰
3. åˆ›å»ºå®Œæ•´çš„è¡¨ç»“æ„
4. æ’å…¥é»˜è®¤æ•°æ®ï¼ˆå¦‚ç®¡ç†å‘˜è´¦æˆ·ï¼‰
5. åº”ç”¨æ­£å¸¸å¯åŠ¨

æ—¥å¿—ç¤ºä¾‹ï¼š
INFO [alembic.runtime.migration] Running upgrade -> 7e5b5dc7342b, init
INFO [alembic.runtime.migration] Running upgrade 7e5b5dc7342b -> ca81bd47c050, add_config_table
...
INFO [alembic.runtime.migration] Running upgrade ef6fab585ac1 -> 24e8f9a7b1c2, add_flux_model_credits
âœ… Tables created successfully
```

### 2. æ›´æ–°éƒ¨ç½²ï¼ˆç°æœ‰æ•°æ®ï¼‰

```
å¯åŠ¨æµç¨‹ï¼š
1. æ£€æµ‹ç°æœ‰æ•°æ®åº“æ–‡ä»¶
2. æ¯”è¾ƒå½“å‰ç‰ˆæœ¬ä¸ç›®æ ‡ç‰ˆæœ¬
3. æ‰§è¡Œå¢é‡è¿ç§»ï¼ˆåªæ‰§è¡Œç¼ºå¤±çš„è¿ç§»ï¼‰
4. å‘åå…¼å®¹å¤„ç†ç¡®ä¿æ—§æ•°æ®æ­£å¸¸è®¿é—®
5. åº”ç”¨æ­£å¸¸å¯åŠ¨ï¼Œæ•°æ®å®Œæ•´ä¿ç•™

æ—¥å¿—ç¤ºä¾‹ï¼š
INFO [alembic.runtime.migration] Current revision: 70c7b727736e
INFO [alembic.runtime.migration] Running upgrade 70c7b727736e -> ef6fab585ac1, add_user_phone_column
INFO [alembic.runtime.migration] Running upgrade ef6fab585ac1 -> 24e8f9a7b1c2, add_flux_model_credits
âœ… Existing users: 1250, Existing chats: 5000+ (æ•°æ®å®Œæ•´ä¿ç•™)
```

### 3. Dockerç¯å¢ƒç‰¹æ®Šå¤„ç†

```yaml
# docker-compose.yaml é…ç½®
services:
  open-webui:
    volumes:
      - open-webui:/app/backend/data # æŒä¹…åŒ–æ•°æ®å·
    environment:
      - DATABASE_URL=sqlite:////app/backend/data/webui.db
    entrypoint: ['/usr/local/bin/docker-entrypoint.sh']
    command: ['bash', 'start.sh']
```

```bash
# docker-entrypoint.sh è‡ªåŠ¨å¤„ç†
#!/bin/bash
echo "ğŸ”§ Installing additional dependencies..."
if ! python -c "import cos_python_sdk_v5" 2>/dev/null; then
    pip install cos-python-sdk-v5==1.9.30
fi

echo "ğŸ”„ Starting database migrations..."
# åº”ç”¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»

echo "ğŸš€ Starting Open WebUI..."
exec "$@"
```

## ğŸ” æ•…éšœè¯Šæ–­å’Œæ¢å¤

### 1. è¿ç§»å¤±è´¥å¤„ç†

```python
# config.py ä¸­çš„æ•…éšœæ¢å¤æœºåˆ¶
try:
    run_migrations()  # å°è¯•Alembicè¿ç§»
except Exception as e:
    log.exception(f"Error running migrations: {e}")

    # è‡ªåŠ¨fallbackåˆ°ç›´æ¥åˆ›å»ºè¡¨
    try:
        log.info("Attempting to create tables directly")
        from open_webui.internal.db import engine, Base
        Base.metadata.create_all(bind=engine)
        log.info("Tables created successfully")
    except Exception as create_error:
        log.exception(f"Error creating tables directly: {create_error}")
```

### 2. æ•°æ®ä¿®å¤è„šæœ¬

```python
# fix_db_startup.py ç‹¬ç«‹ä¿®å¤è„šæœ¬
def run_migrations_sync():
    """åŒæ­¥æ‰§è¡Œæ•°æ®åº“è¿ç§»"""
    try:
        print("ğŸ”„ å¼€å§‹æ‰§è¡Œæ•°æ®åº“è¿ç§»...")

        from alembic import command
        from alembic.config import Config

        command.upgrade(alembic_cfg, "head")
        print("âœ… æ•°æ®åº“è¿ç§»æ‰§è¡ŒæˆåŠŸ!")

    except Exception as e:
        print(f"âŒ è¿ç§»æ‰§è¡Œå¤±è´¥: {e}")

        # å°è¯•ç›´æ¥åˆ›å»ºè¡¨
        try:
            from open_webui.internal.db import engine, Base
            Base.metadata.create_all(bind=engine)
            print("âœ… æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ!")
        except Exception as create_error:
            print(f"âŒ è¡¨åˆ›å»ºä¹Ÿå¤±è´¥: {create_error}")

# ä½¿ç”¨æ–¹æ³•
if __name__ == "__main__":
    success = run_migrations_sync()
    sys.exit(0 if success else 1)
```

## ğŸ“Š éªŒè¯å’Œç›‘æ§

### 1. è¿ç§»çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥å½“å‰è¿ç§»ç‰ˆæœ¬
python -m alembic -c backend/open_webui/alembic.ini current

# æŸ¥çœ‹è¿ç§»å†å²
python -m alembic -c backend/open_webui/alembic.ini history

# æŸ¥çœ‹å¾…æ‰§è¡Œçš„è¿ç§»
python -m alembic -c backend/open_webui/alembic.ini show head
```

### 2. æ•°æ®å®Œæ•´æ€§éªŒè¯

```python
# éªŒè¯å…³é”®æ¨¡å‹æ˜¯å¦æ­£å¸¸
def verify_database_integrity():
    try:
        from open_webui.models.users import Users
        from open_webui.models.tools import Tools
        from open_webui.models.flux import FluxConfigs

        # æµ‹è¯•ç”¨æˆ·æ¨¡å‹
        users = Users.get_users(limit=1)
        print(f"âœ… Users: {len(users.get('users', []))} found")

        # æµ‹è¯•å·¥å…·æ¨¡å‹
        tools = Tools.get_tools()
        print(f"âœ… Tools: {len(tools)} found")

        # æµ‹è¯•Fluxé…ç½®
        config = FluxConfigs.get_config()
        print(f"âœ… Flux config: {'exists' if config else 'not configured'}")

        print("âœ… Database integrity check passed!")
        return True

    except Exception as e:
        print(f"âŒ Database integrity check failed: {e}")
        return False
```

## âš™ï¸ é…ç½®å’Œç¯å¢ƒå˜é‡

### å…³é”®é…ç½®é¡¹

```python
# æ•°æ®åº“é…ç½®
DATABASE_URL = "sqlite:///data/webui.db"  # é»˜è®¤SQLite
# DATABASE_URL = "postgresql://user:pass@localhost/db"  # ç”Ÿäº§ç¯å¢ƒå¯ç”¨PostgreSQL

# è¿ç§»é…ç½®
ENABLE_AUTO_MIGRATION = True    # å¯ç”¨è‡ªåŠ¨è¿ç§»
MIGRATION_TIMEOUT = 30          # è¿ç§»è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
ENABLE_FALLBACK_CREATE = True   # å¯ç”¨fallbackè¡¨åˆ›å»º

# å…¼å®¹æ€§é…ç½®
ENABLE_BACKWARD_COMPATIBILITY = True  # å¯ç”¨å‘åå…¼å®¹
LOG_COMPATIBILITY_WARNINGS = True     # è®°å½•å…¼å®¹æ€§è­¦å‘Š
```

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

### 1. è¿ç§»å¼€å‘è§„èŒƒ

- **åªæ·»åŠ ä¸åˆ é™¤** - ç”Ÿäº§ç¯å¢ƒç»ä¸åˆ é™¤è¡¨æˆ–åˆ—
- **nullable=True** - æ–°åˆ—å¿…é¡»å…è®¸NULL
- **å…ˆæµ‹è¯•åéƒ¨ç½²** - åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯è¿ç§»
- **ç‰ˆæœ¬æ§åˆ¶** - è¿ç§»æ–‡ä»¶çº³å…¥Gitç®¡ç†

### 2. éƒ¨ç½²ç­–ç•¥

- **æ•°æ®å¤‡ä»½** - é‡è¦æ›´æ–°å‰å¤‡ä»½æ•°æ®åº“
- **åˆ†é˜¶æ®µéƒ¨ç½²** - å…ˆéƒ¨ç½²æµ‹è¯•ç¯å¢ƒï¼Œå†ç”Ÿäº§ç¯å¢ƒ
- **ç›‘æ§æ—¥å¿—** - å…³æ³¨è¿ç§»æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
- **å›æ»šå‡†å¤‡** - å‡†å¤‡å›æ»šæ–¹æ¡ˆï¼ˆé€šå¸¸æ˜¯ä»£ç å›æ»šï¼‰

### 3. æ•…éšœå¤„ç†

- **æ—¥å¿—åˆ†æ** - æ ¹æ®é”™è¯¯æ—¥å¿—åˆ¤æ–­é—®é¢˜ç±»å‹
- **å…¼å®¹æ¨¡å¼** - åˆ©ç”¨å‘åå…¼å®¹æœºåˆ¶ä¸´æ—¶æ¢å¤æœåŠ¡
- **æ‰‹åŠ¨ä¿®å¤** - ä½¿ç”¨fix_db_startup.pyè„šæœ¬æ‰‹åŠ¨ä¿®å¤
- **ä¸“å®¶æ”¯æŒ** - å¤æ‚é—®é¢˜åŠæ—¶å¯»æ±‚æŠ€æœ¯æ”¯æŒ

è¿™ä¸ªæ•°æ®åº“è¿ç§»ç³»ç»Ÿç»è¿‡å®æˆ˜éªŒè¯ï¼Œèƒ½å¤Ÿå¤„ç†ä»å…¨æ–°éƒ¨ç½²åˆ°å¤æ‚æ›´æ–°çš„å„ç§åœºæ™¯ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

## ğŸ†• æ–°åŠŸèƒ½å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½çš„æ ‡å‡†æµç¨‹

å½“éœ€è¦ä¸ºç³»ç»Ÿæ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œéµå¾ªä»¥ä¸‹æ ‡å‡†åŒ–æµç¨‹ç¡®ä¿æ•°æ®è¿ç§»å®‰å…¨ï¼š

#### Step 1: åˆ›å»ºè¿ç§»æ–‡ä»¶

```bash
cd backend
python -m alembic revision -m "add_your_new_feature"
```

#### Step 2: ç¼–å†™å®‰å…¨çš„è¿ç§»è„šæœ¬

```python
# migrations/versions/xxx_add_new_feature.py
"""add_new_feature

Revision ID: xxx
Revises: previous_revision
Create Date: 2025-xx-xx xx:xx:xx.xxxxxx
"""

def upgrade() -> None:
    """å‡çº§æ“ä½œï¼šå®‰å…¨æ·»åŠ æ–°åŠŸèƒ½çš„æ•°æ®åº“ç»“æ„"""
    connection = op.get_bind()
    inspector = sa.inspect(connection)

    # æ£€æŸ¥ç›®æ ‡è¡¨æ˜¯å¦å­˜åœ¨
    if "your_table" in inspector.get_table_names():
        existing_columns = [col["name"] for col in inspector.get_columns("your_table")]

        with op.batch_alter_table("your_table", schema=None) as batch_op:
            # å®‰å…¨æ·»åŠ æ–°åˆ—
            if "new_column" not in existing_columns:
                batch_op.add_column(sa.Column("new_column", sa.String(), nullable=True))
                print("Added new_column to your_table")
            else:
                print("new_column already exists in your_table")

            # æ·»åŠ JSONé…ç½®åˆ—ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if "config_data" not in existing_columns:
                batch_op.add_column(sa.Column("config_data", sa.JSON, nullable=True))
                print("Added config_data to your_table")
    else:
        # åˆ›å»ºæ–°è¡¨ï¼ˆå…¨æ–°åŠŸèƒ½ï¼‰
        op.create_table(
            'your_table',
            sa.Column('id', sa.String(255), primary_key=True),
            sa.Column('user_id', sa.String(255), nullable=False, index=True),
            sa.Column('new_column', sa.String(), nullable=True),
            sa.Column('config_data', sa.JSON, nullable=True),
            sa.Column('created_at', sa.DateTime, nullable=False, server_default=sa.func.now()),
            sa.Column('updated_at', sa.DateTime, nullable=False, server_default=sa.func.now()),
        )
        print("Created new table: your_table")

def downgrade() -> None:
    """é™çº§æ“ä½œï¼šç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼Œé€šå¸¸ç•™ç©º"""
    # ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®åˆ é™¤åˆ—æˆ–è¡¨ï¼Œä»¥é˜²æ•°æ®ä¸¢å¤±
    pass
```

#### Step 3: æ¨¡å‹å±‚å‘åå…¼å®¹å¤„ç†

```python
# models/your_model.py
class YourModel(Base):
    __tablename__ = "your_table"

    id = Column(String(255), primary_key=True)
    user_id = Column(String(255), nullable=False, index=True)
    # ç°æœ‰åˆ—...
    new_column = Column(String(), nullable=True)  # æ–°åŠŸèƒ½åˆ—
    config_data = Column(JSON, nullable=True)     # æ–°åŠŸèƒ½é…ç½®

class YourModels:
    """æ•°æ®åº“æ“ä½œç±»ï¼ŒåŒ…å«å‘åå…¼å®¹å¤„ç†"""

    @staticmethod
    def get_data(user_id: str = None):
        """è·å–æ•°æ® - å‘åå…¼å®¹å¤„ç†"""
        with get_db() as db:
            try:
                # å°è¯•æ­£å¸¸ORMæŸ¥è¯¢
                query = db.query(YourModel)
                if user_id:
                    query = query.filter(YourModel.user_id == user_id)
                return query.all()

            except Exception as e:
                if "no such column" in str(e) and "new_column" in str(e):
                    # æ£€æµ‹åˆ°new_columnåˆ—ç¼ºå¤±ï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼
                    logger.warning("new_columnåˆ—ä¸å­˜åœ¨ï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼æŸ¥è¯¢")

                    # ä½¿ç”¨åŸç”ŸSQLæŸ¥è¯¢ï¼Œè·³è¿‡ç¼ºå¤±çš„åˆ—
                    sql = """
                        SELECT id, user_id, existing_column1, existing_column2,
                               created_at, updated_at
                        FROM your_table
                    """
                    if user_id:
                        sql += " WHERE user_id = :user_id"
                        result = db.execute(text(sql), {"user_id": user_id}).fetchall()
                    else:
                        result = db.execute(text(sql)).fetchall()

                    # æ‰‹åŠ¨æ„å»ºå¯¹è±¡åˆ—è¡¨
                    data_list = []
                    for row in result:
                        data_dict = {
                            "id": row[0],
                            "user_id": row[1],
                            "existing_column1": row[2],
                            "existing_column2": row[3],
                            "new_column": None,      # ç¼ºå¤±å­—æ®µè®¾ä¸ºé»˜è®¤å€¼
                            "config_data": {},       # ç¼ºå¤±é…ç½®è®¾ä¸ºç©ºå­—å…¸
                            "created_at": row[4],
                            "updated_at": row[5],
                        }
                        data_list.append(data_dict)

                    return data_list
                else:
                    # å…¶ä»–ç±»å‹é”™è¯¯ï¼Œé‡æ–°æŠ›å‡º
                    raise e

    @staticmethod
    def create_or_update(data_dict: dict):
        """åˆ›å»ºæˆ–æ›´æ–°æ•°æ® - å‘åå…¼å®¹å¤„ç†"""
        with get_db() as db:
            try:
                # å°è¯•æ­£å¸¸æ“ä½œ
                existing = db.query(YourModel).filter(YourModel.id == data_dict.get("id")).first()

                if existing:
                    # æ›´æ–°ç°æœ‰è®°å½•
                    for key, value in data_dict.items():
                        if hasattr(existing, key):
                            setattr(existing, key, value)
                else:
                    # åˆ›å»ºæ–°è®°å½•
                    new_record = YourModel(**data_dict)
                    db.add(new_record)

                db.commit()
                return True

            except Exception as e:
                if "no such column" in str(e) and ("new_column" in str(e) or "config_data" in str(e)):
                    # å…¼å®¹æ¨¡å¼ï¼šåªæ›´æ–°ç°æœ‰å­—æ®µ
                    logger.warning("æ–°å­—æ®µä¸å­˜åœ¨ï¼Œä½¿ç”¨å…¼å®¹æ¨¡å¼ä¿å­˜")

                    # è¿‡æ»¤æ‰ä¸å­˜åœ¨çš„å­—æ®µ
                    safe_data = {k: v for k, v in data_dict.items()
                               if k in ["id", "user_id", "existing_column1", "existing_column2"]}

                    if data_dict.get("id"):
                        # æ›´æ–°æ“ä½œ
                        db.execute(text("""
                            UPDATE your_table
                            SET existing_column1 = :col1, existing_column2 = :col2,
                                updated_at = CURRENT_TIMESTAMP
                            WHERE id = :record_id
                        """), {
                            "col1": safe_data.get("existing_column1"),
                            "col2": safe_data.get("existing_column2"),
                            "record_id": safe_data.get("id")
                        })
                    else:
                        # æ’å…¥æ“ä½œ
                        import uuid
                        new_id = str(uuid.uuid4())
                        db.execute(text("""
                            INSERT INTO your_table
                            (id, user_id, existing_column1, existing_column2, created_at, updated_at)
                            VALUES (:id, :user_id, :col1, :col2, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                        """), {
                            "id": new_id,
                            "user_id": safe_data.get("user_id"),
                            "col1": safe_data.get("existing_column1"),
                            "col2": safe_data.get("existing_column2"),
                        })

                    db.commit()
                    return True
                else:
                    raise e
```

#### Step 4: éªŒè¯å„ç§éƒ¨ç½²åœºæ™¯

**æœ¬åœ°æµ‹è¯•ï¼š**

```bash
# éªŒè¯è¿ç§»
python -m alembic upgrade head

# éªŒè¯æ¨¡å‹
python -c "from open_webui.models.your_model import YourModels; print('Test OK:', YourModels.get_data())"
```

**Dockeræµ‹è¯•ï¼š**

```bash
# æ„å»ºå¹¶æµ‹è¯•
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# éªŒè¯å®¹å™¨å†…
docker exec -it open-webui python -c "from open_webui.models.your_model import YourModels; print('Docker Test OK')"
```

### ğŸ”„ è‡ªåŠ¨è¿ç§»è§¦å‘æœºåˆ¶

#### å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ

```python
# backend/open_webui/config.py
def delayed_migration_execution():
    """å»¶è¿Ÿæ‰§è¡Œè¿ç§»ï¼Œé¿å…å¾ªç¯å¯¼å…¥"""
    def run_delayed():
        time.sleep(1)  # ç­‰å¾…å¯¼å…¥å®Œæˆ
        run_migrations()

    # é˜»å¡å¼æ‰§è¡Œï¼Œç¡®ä¿è¿ç§»å®Œæˆåå†å¯åŠ¨åº”ç”¨
    migration_thread = threading.Thread(target=run_delayed, daemon=False)
    migration_thread.start()
    migration_thread.join(timeout=30)  # æœ€å¤šç­‰å¾…30ç§’

# åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
delayed_migration_execution()
```

#### ä¸‰å±‚å®¹é”™ç­–ç•¥

```python
def run_migrations():
    """è¿è¡ŒAlembicè¿ç§» - ä¸‰å±‚å®¹é”™"""
    try:
        from alembic import command
        from alembic.config import Config

        alembic_cfg = Config(OPEN_WEBUI_DIR / "alembic.ini")
        migrations_path = OPEN_WEBUI_DIR / "migrations"
        alembic_cfg.set_main_option("script_location", str(migrations_path))

        # ç¬¬ä¸€å±‚ï¼šå°è¯•åˆå¹¶ç‚¹ï¼ˆè§£å†³å¤šå¤´é—®é¢˜ï¼‰
        try:
            command.upgrade(alembic_cfg, "merge_heads_final")
            print("âœ… è¿ç§»æˆåŠŸæ‰§è¡Œåˆ°åˆå¹¶ç‚¹")
        except Exception:
            # ç¬¬äºŒå±‚ï¼šå°è¯•æ‰€æœ‰heads
            try:
                command.upgrade(alembic_cfg, "heads")
                print("âœ… è¿ç§»æˆåŠŸæ‰§è¡Œåˆ°æ‰€æœ‰heads")
            except Exception:
                # ç¬¬ä¸‰å±‚ï¼šæœ€åå°è¯•å•head
                command.upgrade(alembic_cfg, "head")
                print("âœ… è¿ç§»æˆåŠŸæ‰§è¡Œåˆ°head")

    except Exception as e:
        print(f"âš ï¸ Alembicè¿ç§»å¤±è´¥: {e}")
        # Fallback: ç›´æ¥åˆ›å»ºè¡¨ç»“æ„
        try:
            from open_webui.internal.db import engine, Base
            Base.metadata.create_all(bind=engine)
            print("âœ… æ•°æ®åº“è¡¨ç›´æ¥åˆ›å»ºæˆåŠŸ")
        except Exception as create_error:
            print(f"âŒ è¡¨åˆ›å»ºä¹Ÿå¤±è´¥: {create_error}")
            raise create_error
```

### ğŸ“‹ æ–°åŠŸèƒ½å¼€å‘æ£€æŸ¥æ¸…å•

#### è¿ç§»æ–‡ä»¶æ£€æŸ¥

- [ ] è¿ç§»æ–‡ä»¶ä½¿ç”¨æè¿°æ€§åç§°
- [ ] æ£€æŸ¥è¡¨/åˆ—å­˜åœ¨æ€§é¿å…é‡å¤åˆ›å»º
- [ ] æ–°åˆ—è®¾ç½® `nullable=True`
- [ ] é¿å…åˆ é™¤è¡¨æˆ–åˆ—æ“ä½œ
- [ ] åŒ…å«é€‚å½“çš„æ—¥å¿—è¾“å‡º

#### æ¨¡å‹å±‚æ£€æŸ¥

- [ ] ORMæŸ¥è¯¢åŒ…è£…åœ¨ try/except ä¸­
- [ ] æ£€æµ‹ "no such column" é”™è¯¯
- [ ] æä¾›åŸç”ŸSQLå…¼å®¹æŸ¥è¯¢
- [ ] ä¸ºç¼ºå¤±å­—æ®µè®¾ç½®åˆç†é»˜è®¤å€¼
- [ ] åŒ…å«è¯¦ç»†çš„æ—¥å¿—è®°å½•

#### æµ‹è¯•éªŒè¯æ£€æŸ¥

- [ ] æœ¬åœ°ç¯å¢ƒæµ‹è¯•ï¼ˆå…¨æ–°+æ›´æ–°ï¼‰
- [ ] Dockerç¯å¢ƒæµ‹è¯•
- [ ] å‘åå…¼å®¹æ€§éªŒè¯
- [ ] æ€§èƒ½å½±å“è¯„ä¼°
- [ ] æ–‡æ¡£æ›´æ–°

### ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å®‰å…¨åŸåˆ™**
   - æ°¸è¿œä¸è¦åˆ é™¤è¡¨æˆ–åˆ—
   - æ–°åˆ—å¿…é¡»å…è®¸NULLå€¼
   - å……åˆ†æµ‹è¯•åå†éƒ¨ç½²

2. **å…¼å®¹æ€§ä¼˜å…ˆ**
   - æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»å‘åå…¼å®¹
   - æ—§ç‰ˆæœ¬æ•°æ®åº“ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ
   - æ¸è¿›å¼åŠŸèƒ½å¯ç”¨

3. **ç›‘æ§å’Œæ—¥å¿—**
   - è®°å½•è¿ç§»æ‰§è¡Œè¿‡ç¨‹
   - ç›‘æ§å…¼å®¹æ¨¡å¼çš„ä½¿ç”¨æƒ…å†µ
   - åŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜

è¿™å¥—æ ‡å‡†åŒ–æµç¨‹ç¡®ä¿æ–°åŠŸèƒ½æ·»åŠ æ—¶çš„æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚
