# 可灵对口型功能实施方案

## 📋 项目概述

本文档描述了在WXIAI平台中集成可灵对口型（Lip Sync）功能的完整实施方案。该功能将为用户提供高质量的视频对口型服务，支持文本转语音对口型和音频对口型两种模式。

### 🎯 功能目标

- **用户体验**：在现有视频生成页面下添加专门的对口型功能入口
- **功能完整性**：支持两种对口型模式（文本转视频、音频转视频）
- **管理便利性**：提供完善的管理员配置界面
- **系统一致性**：与现有架构保持一致，使用相同的积分和权限系统

## 🏗️ 系统架构设计

### 技术栈

- **前端**：SvelteKit + TypeScript + TailwindCSS
- **后端**：FastAPI + SQLAlchemy + Alembic
- **数据库**：SQLite/PostgreSQL/MySQL（支持多种）
- **外部API**：可灵AI对口型服务

### 架构层次

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端界面层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   侧边栏导航    │  │   对口型工作区   │  │   历史记录面板   │ │
│  │  + 视频口型入口  │  │  参数配置界面    │  │   任务管理      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        API接口层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   对口型API     │  │   配置管理API   │  │   任务管理API   │ │
│  │   /lip-sync/*   │  │   /admin/*      │  │   /tasks/*      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        业务逻辑层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   任务处理      │  │   积分计费      │  │   文件管理      │ │
│  │   轮询机制      │  │   权限验证      │  │   云存储集成    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        数据持久层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   对口型任务表   │  │   配置表        │  │   积分记录表    │ │
│  │   kling_lip_sync │ │   kling_lip_cfg │  │   credit_log    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        外部服务层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   可灵API       │  │   云存储COS     │  │   支付系统      │ │
│  │   对口型服务     │  │   文件存储      │  │   积分充值      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🎨 前端设计

### 1. 侧边栏导航扩展

在现有侧边栏的"视频生成"菜单下添加"视频口型"入口：

```html
<!-- 在 /src/lib/components/layout/Sidebar.svelte 中添加 -->
<div class="px-[7px] flex justify-center text-gray-800 dark:text-gray-200">
	<a
		class="grow flex items-center space-x-3 rounded-lg px-2 py-2 hover:bg-gray-100 dark:hover:bg-gray-900 transition"
		href="/lip-sync"
		on:click="{itemClickHandler}"
		draggable="false"
	>
		<div class="self-center">
			<!-- 对口型图标 -->
			<svg class="size-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
				<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" />
				<path d="M8 14s1.5 2 4 2 4-2 4-2" />
				<path d="M9 9h.01" />
				<path d="M15 9h.01" />
			</svg>
		</div>
		<div class="flex self-center translate-y-[0.5px]">
			<div class="self-center text-sm font-primary">视频口型</div>
		</div>
	</a>
</div>
```

### 2. 对口型工作页面

创建 `/src/routes/(app)/lip-sync/+page.svelte`：

#### 页面布局

- **左侧工作区**：参数配置和操作面板
- **右侧历史区**：任务历史和结果展示
- **布局特点**：与现有视频生成页面保持一致的设计风格

#### 核心功能模块

```typescript
// 主要状态管理
let selectedMode: 'text2video' | 'audio2video' = 'text2video';
let isGenerating = false;
let currentTask: KlingLipSyncTask | null = null;
let generatedVideo: KlingLipSyncTask | null = null;
let taskHistory: KlingLipSyncTask[] = [];
let userCredits = 0;

// 文本转视频参数
let prompt = '';
let voiceId = 'genshin_vindi2'; // 默认为阳光少年
let voiceLanguage = 'zh';
let voiceSpeed = 1.0;

// 音频转视频参数
let audioFile: string | null = null;
let audioType: 'file' | 'url' = 'file';
let audioUrl = '';

// 视频输入参数
let videoInput: string | null = null; // video_id 或 video_url
let inputType: 'video_id' | 'video_url' = 'video_url';
```

#### 界面组件

1. **模式切换器**：文本转视频 / 音频转视频
2. **视频输入区**：支持video_id和video_url两种方式
3. **文本输入区**（文本模式）：提示词、音色选择、语速调节
4. **音频输入区**（音频模式）：文件上传或URL输入
5. **生成按钮**：显示所需积分和生成状态
6. **结果展示区**：最新生成的视频预览
7. **历史记录**：任务列表和筛选功能

#### 音色选择器实现

```svelte
<script lang="ts">
	// 完整音色选项配置（与管理员界面一致）
	const chineseVoiceOptions = [
		{ value: 'genshin_vindi2', label: '阳光少年' },
		{ value: 'zhinen_xuesheng', label: '懂事小弟' },
		{ value: 'tiyuxi_xuedi', label: '运动少年' },
		{ value: 'ai_shatang', label: '青春少女' },
		{ value: 'genshin_klee2', label: '温柔小妹' },
		{ value: 'genshin_kirara', label: '元气少女' },
		{ value: 'ai_kaiya', label: '阳光男生' },
		{ value: 'tiexin_nanyou', label: '幽默小哥' },
		{ value: 'ai_chenjiahao_712', label: '文艺小哥' },
		{ value: 'girlfriend_1_speech02', label: '甜美邻家' },
		{ value: 'chat1_female_new-3', label: '温柔姐姐' },
		{ value: 'girlfriend_2_speech02', label: '职场女青' },
		{ value: 'cartoon-boy-07', label: '活泼男童' },
		{ value: 'cartoon-girl-01', label: '俏皮女童' },
		{ value: 'ai_huangyaoshi_712', label: '稳重老爸' },
		{ value: 'you_pingjing', label: '温柔妈妈' },
		{ value: 'ai_laoguowang_712', label: '严肃上司' },
		{ value: 'chengshu_jiejie', label: '优雅贵妇' },
		{ value: 'zhuxi_speech02', label: '慈祥爷爷' },
		{ value: 'uk_oldman3', label: '唠叨爷爷' },
		{ value: 'laopopo_speech02', label: '唠叨奶奶' },
		{ value: 'heainainai_speech02', label: '和蔼奶奶' },
		{ value: 'dongbeilaotie_speech02', label: '东北老铁' },
		{ value: 'chongqingxiaohuo_speech02', label: '重庆小伙' },
		{ value: 'chuanmeizi_speech02', label: '四川妹子' },
		{ value: 'chaoshandashu_speech02', label: '潮汕大叔' },
		{ value: 'ai_taiwan_man2_speech02', label: '台湾男生' },
		{ value: 'xianzhanggui_speech02', label: '西安掌柜' },
		{ value: 'tianjinjiejie_speech02', label: '天津姐姐' },
		{ value: 'diyinnansang_DB_CN_M_04-v2', label: '新闻播报男' },
		{ value: 'yizhipiannan-v1', label: '译制片男' },
		{ value: 'guanxiaofang-v2', label: '元气少女' },
		{ value: 'tianmeixuemei-v1', label: '撒娇女友' },
		{ value: 'daopianyansang-v1', label: '刀片烟嗓' },
		{ value: 'mengwa-v1', label: '乖巧正太' }
	];

	const englishVoiceOptions = [
		{ value: 'genshin_vindi2', label: 'Sunny' },
		{ value: 'zhinen_xuesheng', label: 'Sage' },
		{ value: 'AOT', label: 'Ace' },
		{ value: 'ai_shatang', label: 'Blossom' },
		{ value: 'genshin_klee2', label: 'Peppy' },
		{ value: 'genshin_kirara', label: 'Dove' },
		{ value: 'ai_kaiya', label: 'Shine' },
		{ value: 'oversea_male1', label: 'Anchor' },
		{ value: 'ai_chenjiahao_712', label: 'Lyric' },
		{ value: 'girlfriend_4_speech02', label: 'Melody' },
		{ value: 'chat1_female_new-3', label: 'Tender' },
		{ value: 'chat_0407_5-1', label: 'Siren' },
		{ value: 'cartoon-boy-07', label: 'Zippy' },
		{ value: 'uk_boy1', label: 'Bud' },
		{ value: 'cartoon-girl-01', label: 'Sprite' },
		{ value: 'PeppaPig_platform', label: 'Candy' },
		{ value: 'ai_huangzhong_712', label: 'Beacon' },
		{ value: 'ai_huangyaoshi_712', label: 'Rock' },
		{ value: 'ai_laoguowang_712', label: 'Titan' },
		{ value: 'chengshu_jiejie', label: 'Grace' },
		{ value: 'you_pingjing', label: 'Helen' },
		{ value: 'calm_story1', label: 'Lore' },
		{ value: 'uk_man2', label: 'Crag' },
		{ value: 'laopopo_speech02', label: 'Prattle' },
		{ value: 'heainainai_speech02', label: 'Hearth' },
		{ value: 'reader_en_m-v1', label: 'The Reader' },
		{ value: 'commercial_lady_en_f-v1', label: 'Commercial Lady' }
	];

	// 根据语言动态显示音色选项
	$: currentVoiceOptions = voiceLanguage === 'zh' ? chineseVoiceOptions : englishVoiceOptions;

	// 当语言切换时，自动切换默认音色
	$: if (voiceLanguage === 'zh' && !chineseVoiceOptions.find((v) => v.value === voiceId)) {
		voiceId = 'genshin_vindi2'; // 默认中文音色：阳光少年
	} else if (voiceLanguage === 'en' && !englishVoiceOptions.find((v) => v.value === voiceId)) {
		voiceId = 'genshin_vindi2'; // 默认英文音色：Sunny
	}
</script>

<!-- 语言选择会动态切换音色选项 -->
<div class="space-y-4">
	<div>
		<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"> 语言 </label>
		<select bind:value={voiceLanguage} class="form-select">
			<option value="zh">中文</option>
			<option value="en">English</option>
		</select>
	</div>

	<div>
		<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"> 音色 </label>
		<select bind:value={voiceId} class="form-select">
			{#each currentVoiceOptions as option}
				<option value={option.value}>{option.label}</option>
			{/each}
		</select>
	</div>
</div>
```

### 3. 前端API接口

创建 `/src/lib/apis/kling-lip-sync/index.ts`：

```typescript
// 对口型配置接口
export interface KlingLipSyncConfig {
    enabled: boolean;
    baseUrl: string;
    apiKey: string;
    defaultVoiceId: string; // 默认 genshin_vindi2（阳光少年）
    defaultVoiceLanguage: string; // 默认 zh
    defaultVoiceSpeed: number; // 默认 1.0
    creditsCost: number; // 每次对口型消耗的积分，默认 50
}

// 对口型任务接口
export interface KlingLipSyncTask {
    id: string;
    userId: string;
    mode: 'text2video' | 'audio2video';
    status: 'submitted' | 'processing' | 'succeed' | 'failed';

    // 视频输入
    videoInput: string; // video_id 或 video_url
    inputType: 'video_id' | 'video_url';

    // 文本转视频参数
    text?: string;
    voiceId?: string;
    voiceLanguage?: string;
    voiceSpeed?: number;

    // 音频转视频参数
    audioFile?: string; // base64 或 URL
    audioType?: 'file' | 'url';

    // 结果
    videoUrl?: string;
    videoDuration?: string;
    failReason?: string;

    // 任务管理
    creditsCost: number;
    submitTime: string;
    finishTime?: string;
    progress: string;
    createdAt: string;
    updatedAt: string;
}

// API函数
export const getKlingLipSyncConfig = async (token: string): Promise<KlingLipSyncConfig>;
export const saveKlingLipSyncConfig = async (token: string, config: KlingLipSyncConfig): Promise<any>;
export const submitKlingLipSyncTask = async (token: string, request: KlingLipSyncRequest): Promise<any>;
export const getKlingLipSyncTaskStatus = async (token: string, taskId: string): Promise<KlingLipSyncTask>;
export const getKlingLipSyncHistory = async (token: string, page: number, limit: number): Promise<any>;
export const deleteKlingLipSyncTask = async (token: string, taskId: string): Promise<boolean>;
```

## 🔧 后端设计

### 1. 数据模型设计

创建 `/backend/open_webui/models/kling_lip_sync.py`：

```python
from sqlalchemy import Column, String, Integer, Boolean, DateTime, Text, Float, JSON
from sqlalchemy.sql import func
from open_webui.internal.db import Base
import uuid

class KlingLipSyncConfig(Base):
    __tablename__ = "kling_lip_sync_config"

    id = Column(Integer, primary_key=True)
    enabled = Column(Boolean, default=False)
    base_url = Column(String(500), default="https://api.kling.com")
    api_key = Column(Text)
    default_voice_id = Column(String(50), default="genshin_vindi2")
    default_voice_language = Column(String(10), default="zh")
    default_voice_speed = Column(Float, default=1.0)
    credits_cost = Column(Integer, default=50)  # 每次对口型消耗的积分
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())

class KlingLipSyncTask(Base):
    __tablename__ = "kling_lip_sync_tasks"

    id = Column(String(50), primary_key=True, default=lambda: str(uuid.uuid4()))
    user_id = Column(String(50), nullable=False, index=True)

    # 任务状态
    status = Column(String(50), default="submitted", index=True)
    task_status_msg = Column(Text)

    # 输入参数
    mode = Column(String(20), nullable=False)  # text2video, audio2video
    video_input = Column(Text, nullable=False)  # video_id 或 video_url
    input_type = Column(String(20), nullable=False)  # video_id, video_url

    # 文本转视频参数
    text = Column(Text)
    voice_id = Column(String(50))
    voice_language = Column(String(10))
    voice_speed = Column(Float)

    # 音频转视频参数
    audio_file = Column(Text)  # base64 或 URL
    audio_type = Column(String(10))  # file, url

    # 结果
    video_url = Column(Text)
    video_duration = Column(String(10))
    fail_reason = Column(Text)

    # 任务管理
    credits_cost = Column(Integer, default=50)
    submit_time = Column(DateTime, default=func.now())
    finish_time = Column(DateTime)
    progress = Column(String(10), default="0%")

    # 元数据
    properties = Column(JSON)
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())

class KlingLipSyncCredit(Base):
    __tablename__ = "kling_lip_sync_credits"

    id = Column(String(50), primary_key=True, default=lambda: str(uuid.uuid4()))
    user_id = Column(String(50), nullable=False, index=True)
    task_id = Column(String(50), nullable=False)
    credit_amount = Column(Integer, nullable=False)
    operation_type = Column(String(20), nullable=False)  # deduct, refund
    created_at = Column(DateTime, default=func.now())
```

### 2. API路由设计

创建 `/backend/open_webui/routers/kling_lip_sync.py`：

```python
from fastapi import APIRouter, Depends, HTTPException, status, File, UploadFile
from pydantic import BaseModel
from typing import Optional, Union, List
import uuid
from datetime import datetime

from open_webui.models.kling_lip_sync import (
    KlingLipSyncConfig,
    KlingLipSyncTask,
    KlingLipSyncCredit
)
from open_webui.utils.auth import get_current_user, get_admin_user
from open_webui.utils.kling_lip_sync import KlingLipSyncAPI
from open_webui.utils.credit.usage import CreditDeduct

router = APIRouter()

# ======================== 数据模型 ========================

class KlingLipSyncConfigModel(BaseModel):
    enabled: bool = False
    base_url: str = "https://api.kling.com"
    api_key: str = ""
    default_voice_id: str = "genshin_vindi2"
    default_voice_language: str = "zh"
    default_voice_speed: float = 1.0
    credits_cost: int = 50

class KlingLipSyncRequest(BaseModel):
    mode: str  # text2video, audio2video
    video_input: str  # video_id 或 video_url
    input_type: str  # video_id, video_url

    # 文本转视频参数
    text: Optional[str] = None
    voice_id: Optional[str] = None
    voice_language: Optional[str] = "zh"
    voice_speed: Optional[float] = 1.0

    # 音频转视频参数
    audio_file: Optional[str] = None  # base64数据
    audio_url: Optional[str] = None
    audio_type: Optional[str] = "file"

    callback_url: Optional[str] = None

# ======================== 管理员接口 ========================

@router.get("/config", dependencies=[Depends(get_admin_user)])
async def get_kling_lip_sync_config():
    """获取可灵对口型配置（管理员）"""
    config = get_kling_lip_sync_config_from_db()
    return config

@router.post("/config", dependencies=[Depends(get_admin_user)])
async def save_kling_lip_sync_config(config: KlingLipSyncConfigModel):
    """保存可灵对口型配置（管理员）"""
    save_kling_lip_sync_config_to_db(config)
    return {"success": True, "message": "配置保存成功"}

@router.get("/test", dependencies=[Depends(get_admin_user)])
async def test_kling_lip_sync_connection():
    """测试可灵对口型连接"""
    config = get_kling_lip_sync_config_from_db()
    if not config.enabled:
        raise HTTPException(status_code=400, detail="可灵对口型服务未启用")

    api = KlingLipSyncAPI(config.base_url, config.api_key)
    result = await api.test_connection()
    return result

# ======================== 用户接口 ========================

@router.get("/config/user")
async def get_user_kling_lip_sync_config(user=Depends(get_current_user)):
    """获取用户可见的可灵对口型配置"""
    config = get_kling_lip_sync_config_from_db()
    return {
        "enabled": config.enabled,
        "default_voice_id": config.default_voice_id,
        "default_voice_language": config.default_voice_language,
        "default_voice_speed": config.default_voice_speed,
        "credits_cost": config.credits_cost
    }

@router.post("/submit")
async def submit_kling_lip_sync_task(request: KlingLipSyncRequest, user=Depends(get_current_user)):
    """提交对口型任务"""
    config = get_kling_lip_sync_config_from_db()
    if not config.enabled:
        raise HTTPException(status_code=400, detail="可灵对口型服务未启用")

    # 验证积分
    credit_deduct = CreditDeduct(user.id)
    if not credit_deduct.has_sufficient_credit(config.credits_cost):
        raise HTTPException(status_code=400, detail="积分不足")

    # 创建任务
    task_id = str(uuid.uuid4())
    task = KlingLipSyncTask(
        id=task_id,
        user_id=user.id,
        mode=request.mode,
        video_input=request.video_input,
        input_type=request.input_type,
        text=request.text,
        voice_id=request.voice_id or config.default_voice_id,
        voice_language=request.voice_language or config.default_voice_language,
        voice_speed=request.voice_speed or config.default_voice_speed,
        audio_file=request.audio_file,
        audio_type=request.audio_type,
        credits_cost=config.credits_cost,
        status="submitted"
    )

    # 保存到数据库
    save_task_to_db(task)

    # 扣除积分
    credit_deduct.deduct_credit(config.credits_cost, {
        "service": "kling_lip_sync",
        "task_id": task_id,
        "mode": request.mode
    })

    # 提交到可灵API
    api = KlingLipSyncAPI(config.base_url, config.api_key)
    result = await api.submit_lip_sync_task(request)

    if result.get("success"):
        # 更新任务状态
        task.status = "processing"
        update_task_in_db(task)

        return {
            "success": True,
            "task_id": task_id,
            "message": "任务提交成功"
        }
    else:
        # 任务提交失败，退还积分
        credit_deduct.refund_credit(config.credits_cost, {
            "service": "kling_lip_sync",
            "task_id": task_id,
            "reason": "task_submit_failed"
        })
        task.status = "failed"
        task.fail_reason = result.get("message", "任务提交失败")
        update_task_in_db(task)

        raise HTTPException(status_code=400, detail=result.get("message", "任务提交失败"))

@router.get("/task/{task_id}")
async def get_kling_lip_sync_task_status(task_id: str, user=Depends(get_current_user)):
    """获取任务状态"""
    task = get_task_from_db(task_id, user.id)
    if not task:
        raise HTTPException(status_code=404, detail="任务不存在")

    # 如果任务还在处理中，查询可灵API获取最新状态
    if task.status in ["submitted", "processing"]:
        config = get_kling_lip_sync_config_from_db()
        api = KlingLipSyncAPI(config.base_url, config.api_key)
        result = await api.get_task_status(task_id)

        # 更新任务状态
        if result:
            task.status = result.get("status", task.status)
            task.progress = result.get("progress", task.progress)
            task.video_url = result.get("video_url", task.video_url)
            task.fail_reason = result.get("fail_reason", task.fail_reason)

            if task.status == "succeed" and task.video_url:
                task.finish_time = datetime.now()

            update_task_in_db(task)

    return task_to_dict(task)

@router.get("/history")
async def get_kling_lip_sync_history(
    page: int = 1,
    limit: int = 20,
    user=Depends(get_current_user)
):
    """获取用户任务历史"""
    tasks = get_user_tasks_from_db(user.id, page, limit)
    total = get_user_tasks_count(user.id)

    return {
        "data": [task_to_dict(task) for task in tasks],
        "total": total,
        "page": page,
        "limit": limit
    }

@router.delete("/task/{task_id}")
async def delete_kling_lip_sync_task(task_id: str, user=Depends(get_current_user)):
    """删除任务"""
    task = get_task_from_db(task_id, user.id)
    if not task:
        raise HTTPException(status_code=404, detail="任务不存在")

    delete_task_from_db(task_id, user.id)
    return {"success": True, "message": "任务删除成功"}

@router.get("/credits")
async def get_kling_lip_sync_credits(user=Depends(get_current_user)):
    """获取用户积分余额"""
    credit_deduct = CreditDeduct(user.id)
    return {"balance": credit_deduct.get_current_balance()}
```

### 3. 业务逻辑实现

创建 `/backend/open_webui/utils/kling_lip_sync.py`：

```python
import aiohttp
import asyncio
import json
import base64
from typing import Dict, Any, Optional
from datetime import datetime

class KlingLipSyncAPI:
    """可灵对口型API客户端"""

    def __init__(self, base_url: str, api_key: str):
        self.base_url = base_url.rstrip('/')
        self.api_key = api_key
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }

    async def test_connection(self) -> Dict[str, Any]:
        """测试API连接"""
        try:
            async with aiohttp.ClientSession() as session:
                # 这里可以调用可灵API的健康检查接口
                async with session.get(
                    f"{self.base_url}/v1/videos/lip-sync",
                    headers=self.headers,
                    timeout=10
                ) as response:
                    if response.status == 200:
                        return {"status": "success", "message": "连接成功"}
                    else:
                        return {"status": "error", "message": f"连接失败: HTTP {response.status}"}
        except Exception as e:
            return {"status": "error", "message": f"连接异常: {str(e)}"}

    async def submit_lip_sync_task(self, request) -> Dict[str, Any]:
        """提交对口型任务"""
        try:
            # 构建请求数据
            data = {
                "input": {
                    request.input_type: request.video_input,
                    "mode": request.mode
                }
            }

            if request.mode == "text2video":
                data["input"].update({
                    "text": request.text,
                    "voice_id": request.voice_id,
                    "voice_language": request.voice_language,
                    "voice_speed": request.voice_speed
                })
            elif request.mode == "audio2video":
                data["input"].update({
                    "audio_type": request.audio_type,
                })
                if request.audio_type == "file":
                    data["input"]["audio_file"] = request.audio_file
                else:
                    data["input"]["audio_url"] = request.audio_url

            if request.callback_url:
                data["callback_url"] = request.callback_url

            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{self.base_url}/v1/videos/lip-sync",
                    headers=self.headers,
                    json=data,
                    timeout=30
                ) as response:
                    result = await response.json()

                    if response.status == 200 and result.get("code") == 0:
                        return {
                            "success": True,
                            "task_id": result["data"]["task_id"],
                            "message": "任务提交成功"
                        }
                    else:
                        return {
                            "success": False,
                            "message": result.get("message", "任务提交失败")
                        }
        except Exception as e:
            return {
                "success": False,
                "message": f"API调用异常: {str(e)}"
            }

    async def get_task_status(self, task_id: str) -> Optional[Dict[str, Any]]:
        """获取任务状态"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{self.base_url}/v1/videos/lip-sync/{task_id}",
                    headers=self.headers,
                    timeout=10
                ) as response:
                    result = await response.json()

                    if response.status == 200 and result.get("code") == 0:
                        data = result["data"]

                        # 转换状态映射
                        status_mapping = {
                            "submitted": "submitted",
                            "processing": "processing",
                            "succeed": "succeed",
                            "failed": "failed"
                        }

                        return {
                            "status": status_mapping.get(data["task_status"], "processing"),
                            "progress": "100%" if data["task_status"] == "succeed" else "0%",
                            "video_url": data.get("task_result", {}).get("videos", [{}])[0].get("url") if data["task_status"] == "succeed" else None,
                            "fail_reason": data.get("task_status_msg") if data["task_status"] == "failed" else None
                        }

                    return None
        except Exception as e:
            print(f"获取任务状态失败: {str(e)}")
            return None
```

## 🔧 管理员配置界面

### 1. 配置页面设计

在管理员面板中添加可灵对口型配置页面：

路径：`/src/routes/(app)/admin/settings/kling-lip-sync/+page.svelte`

```svelte
<script lang="ts">
	import { onMount } from 'svelte';
	import { toast } from 'svelte-sonner';
	import {
		getKlingLipSyncConfig,
		saveKlingLipSyncConfig,
		testKlingLipSyncConnection
	} from '$lib/apis/kling-lip-sync';
	import { user } from '$lib/stores';

	let config = {
		enabled: false,
		baseUrl: 'https://api.kling.com',
		apiKey: '',
		defaultVoiceId: 'genshin_vindi2',
		defaultVoiceLanguage: 'zh',
		defaultVoiceSpeed: 1.0,
		creditsCost: 50
	};

	let saving = false;
	let testing = false;
	let testResult = null;

	// 音色选项 - 根据语言动态显示
	const chineseVoiceOptions = [
		{ value: 'genshin_vindi2', label: '阳光少年' },
		{ value: 'zhinen_xuesheng', label: '懂事小弟' },
		{ value: 'tiyuxi_xuedi', label: '运动少年' },
		{ value: 'ai_shatang', label: '青春少女' },
		{ value: 'genshin_klee2', label: '温柔小妹' },
		{ value: 'genshin_kirara', label: '元气少女' },
		{ value: 'ai_kaiya', label: '阳光男生' },
		{ value: 'tiexin_nanyou', label: '幽默小哥' },
		{ value: 'ai_chenjiahao_712', label: '文艺小哥' },
		{ value: 'girlfriend_1_speech02', label: '甜美邻家' },
		{ value: 'chat1_female_new-3', label: '温柔姐姐' },
		{ value: 'girlfriend_2_speech02', label: '职场女青' },
		{ value: 'cartoon-boy-07', label: '活泼男童' },
		{ value: 'cartoon-girl-01', label: '俏皮女童' },
		{ value: 'ai_huangyaoshi_712', label: '稳重老爸' },
		{ value: 'you_pingjing', label: '温柔妈妈' },
		{ value: 'ai_laoguowang_712', label: '严肃上司' },
		{ value: 'chengshu_jiejie', label: '优雅贵妇' },
		{ value: 'zhuxi_speech02', label: '慈祥爷爷' },
		{ value: 'uk_oldman3', label: '唠叨爷爷' },
		{ value: 'laopopo_speech02', label: '唠叨奶奶' },
		{ value: 'heainainai_speech02', label: '和蔼奶奶' },
		{ value: 'dongbeilaotie_speech02', label: '东北老铁' },
		{ value: 'chongqingxiaohuo_speech02', label: '重庆小伙' },
		{ value: 'chuanmeizi_speech02', label: '四川妹子' },
		{ value: 'chaoshandashu_speech02', label: '潮汕大叔' },
		{ value: 'ai_taiwan_man2_speech02', label: '台湾男生' },
		{ value: 'xianzhanggui_speech02', label: '西安掌柜' },
		{ value: 'tianjinjiejie_speech02', label: '天津姐姐' },
		{ value: 'diyinnansang_DB_CN_M_04-v2', label: '新闻播报男' },
		{ value: 'yizhipiannan-v1', label: '译制片男' },
		{ value: 'guanxiaofang-v2', label: '元气少女' },
		{ value: 'tianmeixuemei-v1', label: '撒娇女友' },
		{ value: 'daopianyansang-v1', label: '刀片烟嗓' },
		{ value: 'mengwa-v1', label: '乖巧正太' }
	];

	const englishVoiceOptions = [
		{ value: 'genshin_vindi2', label: 'Sunny' },
		{ value: 'zhinen_xuesheng', label: 'Sage' },
		{ value: 'AOT', label: 'Ace' },
		{ value: 'ai_shatang', label: 'Blossom' },
		{ value: 'genshin_klee2', label: 'Peppy' },
		{ value: 'genshin_kirara', label: 'Dove' },
		{ value: 'ai_kaiya', label: 'Shine' },
		{ value: 'oversea_male1', label: 'Anchor' },
		{ value: 'ai_chenjiahao_712', label: 'Lyric' },
		{ value: 'girlfriend_4_speech02', label: 'Melody' },
		{ value: 'chat1_female_new-3', label: 'Tender' },
		{ value: 'chat_0407_5-1', label: 'Siren' },
		{ value: 'cartoon-boy-07', label: 'Zippy' },
		{ value: 'uk_boy1', label: 'Bud' },
		{ value: 'cartoon-girl-01', label: 'Sprite' },
		{ value: 'PeppaPig_platform', label: 'Candy' },
		{ value: 'ai_huangzhong_712', label: 'Beacon' },
		{ value: 'ai_huangyaoshi_712', label: 'Rock' },
		{ value: 'ai_laoguowang_712', label: 'Titan' },
		{ value: 'chengshu_jiejie', label: 'Grace' },
		{ value: 'you_pingjing', label: 'Helen' },
		{ value: 'calm_story1', label: 'Lore' },
		{ value: 'uk_man2', label: 'Crag' },
		{ value: 'laopopo_speech02', label: 'Prattle' },
		{ value: 'heainainai_speech02', label: 'Hearth' },
		{ value: 'reader_en_m-v1', label: 'The Reader' },
		{ value: 'commercial_lady_en_f-v1', label: 'Commercial Lady' }
	];

	// 根据语言获取音色选项
	$: currentVoiceOptions =
		config.defaultVoiceLanguage === 'zh' ? chineseVoiceOptions : englishVoiceOptions;

	const languageOptions = [
		{ value: 'zh', label: '中文' },
		{ value: 'en', label: '英文' }
	];

	onMount(async () => {
		await loadConfig();
	});

	const loadConfig = async () => {
		try {
			const result = await getKlingLipSyncConfig($user.token);
			if (result) {
				config = result;
			}
		} catch (error) {
			toast.error('加载配置失败');
		}
	};

	const saveConfig = async () => {
		saving = true;
		try {
			await saveKlingLipSyncConfig($user.token, config);
			toast.success('配置保存成功');
		} catch (error) {
			toast.error('保存配置失败');
		}
		saving = false;
	};

	const testConnection = async () => {
		if (!config.apiKey) {
			toast.error('请先填写API密钥');
			return;
		}

		testing = true;
		testResult = null;

		try {
			const result = await testKlingLipSyncConnection($user.token);
			testResult = result;

			if (result.status === 'success') {
				toast.success('连接测试成功');
			} else {
				toast.error(`连接测试失败: ${result.message}`);
			}
		} catch (error) {
			testResult = { status: 'error', message: '连接测试异常' };
			toast.error('连接测试异常');
		}

		testing = false;
	};
</script>

<div class="min-h-screen max-h-screen overflow-y-auto w-full">
	<div class="px-8 py-6">
		<div class="mb-6">
			<h1 class="text-2xl font-semibold text-gray-900 dark:text-white">可灵对口型配置</h1>
			<p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
				配置可灵AI视频对口型服务，支持文本转语音对口型和音频对口型功能。
			</p>
		</div>

		<div class="bg-white dark:bg-gray-800 shadow rounded-lg">
			<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-600">
				<h3 class="text-lg font-medium text-gray-900 dark:text-white">基础配置</h3>
			</div>

			<div class="px-6 py-4 space-y-6">
				<!-- 服务启用 -->
				<div class="flex items-center justify-between">
					<div>
						<label class="text-sm font-medium text-gray-700 dark:text-gray-300">
							启用可灵对口型服务
						</label>
						<p class="text-xs text-gray-500 dark:text-gray-400">启用后用户可以使用可灵对口型功能</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" bind:checked={config.enabled} class="sr-only peer" />
						<div
							class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
						></div>
					</label>
				</div>

				<!-- API配置 -->
				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						API基础URL
					</label>
					<input
						bind:value={config.baseUrl}
						class="w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm dark:bg-gray-700"
						placeholder="https://api.kling.com"
					/>
				</div>

				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						API密钥
					</label>
					<div class="flex gap-2">
						<input
							type="password"
							bind:value={config.apiKey}
							class="flex-1 rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm dark:bg-gray-700"
							placeholder="sk-xxx..."
						/>
						<button
							on:click={testConnection}
							disabled={testing || !config.apiKey}
							class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
						>
							{testing ? '测试中...' : '测试连接'}
						</button>
					</div>

					{#if testResult}
						<div
							class="mt-2 p-2 rounded text-xs {testResult.status === 'success'
								? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'
								: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}"
						>
							{testResult.message}
						</div>
					{/if}
				</div>

				<!-- 默认参数配置 -->
				<div class="border-t border-gray-200 dark:border-gray-600 pt-6">
					<h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">默认参数设置</h4>

					<div class="grid grid-cols-2 gap-4">
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								默认音色
							</label>
							<select
								bind:value={config.defaultVoiceId}
								class="w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm dark:bg-gray-700"
							>
								{#each currentVoiceOptions as option}
									<option value={option.value}>{option.label}</option>
								{/each}
							</select>
						</div>

						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								默认语言
							</label>
							<select
								bind:value={config.defaultVoiceLanguage}
								class="w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm dark:bg-gray-700"
							>
								{#each languageOptions as option}
									<option value={option.value}>{option.label}</option>
								{/each}
							</select>
						</div>

						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								默认语速
							</label>
							<input
								type="number"
								min="0.8"
								max="2.0"
								step="0.1"
								bind:value={config.defaultVoiceSpeed}
								class="w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm dark:bg-gray-700"
							/>
						</div>

						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								积分消耗
							</label>
							<input
								type="number"
								min="1"
								bind:value={config.creditsCost}
								class="w-full rounded-lg border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm dark:bg-gray-700"
							/>
							<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
								每次对口型操作消耗的积分数量
							</p>
						</div>
					</div>
				</div>

				<!-- 保存按钮 -->
				<div class="border-t border-gray-200 dark:border-gray-600 pt-6">
					<button
						on:click={saveConfig}
						disabled={saving}
						class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
					>
						{saving ? '保存中...' : '保存配置'}
					</button>
				</div>
			</div>
		</div>
	</div>
</div>
```

### 2. 管理员导航扩展

在管理员设置页面的侧边栏中添加对口型配置入口：

```html
<!-- 在管理员设置导航中添加 -->
<a href="/admin/settings/kling-lip-sync" class="nav-item">
	<svg class="w-4 h-4" viewBox="0 0 24 24">
		<!-- 对口型图标 -->
	</svg>
	可灵对口型
</a>
```

## 🗄️ 数据库迁移方案

### 1. 迁移文件设计

创建迁移文件 `/backend/open_webui/migrations/versions/xyz_add_kling_lip_sync_tables.py`：

```python
"""add kling lip sync tables

Revision ID: xyz123abc456
Revises: previous_revision
Create Date: 2024-08-24 12:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = 'xyz123abc456'
down_revision = 'previous_revision'  # 替换为实际的上一个revision
branch_labels = None
depends_on = None

def upgrade():
    """创建可灵对口型相关表"""

    # 创建可灵对口型配置表
    op.create_table('kling_lip_sync_config',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('enabled', sa.Boolean(), default=False),
        sa.Column('base_url', sa.String(500), default='https://api.kling.com'),
        sa.Column('api_key', sa.Text(), nullable=True),
        sa.Column('default_voice_id', sa.String(50), default='zh_female_001'),
        sa.Column('default_voice_language', sa.String(10), default='zh'),
        sa.Column('default_voice_speed', sa.Float(), default=1.0),
        sa.Column('credits_cost', sa.Integer(), default=50),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()')),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()')),
        sa.PrimaryKeyConstraint('id')
    )

    # 插入默认配置
    op.execute("""
        INSERT INTO kling_lip_sync_config (enabled, base_url, default_voice_id, default_voice_language, default_voice_speed, credits_cost)
        VALUES (false, 'https://api.kling.com', 'genshin_vindi2', 'zh', 1.0, 50);
    """)

    # 创建可灵对口型任务表
    op.create_table('kling_lip_sync_tasks',
        sa.Column('id', sa.String(50), nullable=False),
        sa.Column('user_id', sa.String(50), nullable=False),
        sa.Column('status', sa.String(50), default='submitted'),
        sa.Column('task_status_msg', sa.Text(), nullable=True),
        sa.Column('mode', sa.String(20), nullable=False),
        sa.Column('video_input', sa.Text(), nullable=False),
        sa.Column('input_type', sa.String(20), nullable=False),
        sa.Column('text', sa.Text(), nullable=True),
        sa.Column('voice_id', sa.String(50), nullable=True),
        sa.Column('voice_language', sa.String(10), nullable=True),
        sa.Column('voice_speed', sa.Float(), nullable=True),
        sa.Column('audio_file', sa.Text(), nullable=True),
        sa.Column('audio_type', sa.String(10), nullable=True),
        sa.Column('video_url', sa.Text(), nullable=True),
        sa.Column('video_duration', sa.String(10), nullable=True),
        sa.Column('fail_reason', sa.Text(), nullable=True),
        sa.Column('credits_cost', sa.Integer(), default=50),
        sa.Column('submit_time', sa.DateTime(), server_default=sa.text('now()')),
        sa.Column('finish_time', sa.DateTime(), nullable=True),
        sa.Column('progress', sa.String(10), default='0%'),
        sa.Column('properties', sa.JSON(), nullable=True),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()')),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()')),
        sa.PrimaryKeyConstraint('id')
    )

    # 创建索引
    op.create_index('idx_kling_lip_sync_user_id', 'kling_lip_sync_tasks', ['user_id'])
    op.create_index('idx_kling_lip_sync_status', 'kling_lip_sync_tasks', ['status'])
    op.create_index('idx_kling_lip_sync_created', 'kling_lip_sync_tasks', ['created_at'])

    # 创建可灵对口型积分记录表
    op.create_table('kling_lip_sync_credits',
        sa.Column('id', sa.String(50), nullable=False),
        sa.Column('user_id', sa.String(50), nullable=False),
        sa.Column('task_id', sa.String(50), nullable=False),
        sa.Column('credit_amount', sa.Integer(), nullable=False),
        sa.Column('operation_type', sa.String(20), nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()')),
        sa.PrimaryKeyConstraint('id')
    )

    # 创建积分记录索引
    op.create_index('idx_kling_lip_sync_credit_user', 'kling_lip_sync_credits', ['user_id'])
    op.create_index('idx_kling_lip_sync_credit_task', 'kling_lip_sync_credits', ['task_id'])

def downgrade():
    """删除可灵对口型相关表"""

    # 删除索引
    op.drop_index('idx_kling_lip_sync_credit_task', 'kling_lip_sync_credits')
    op.drop_index('idx_kling_lip_sync_credit_user', 'kling_lip_sync_credits')
    op.drop_index('idx_kling_lip_sync_created', 'kling_lip_sync_tasks')
    op.drop_index('idx_kling_lip_sync_status', 'kling_lip_sync_tasks')
    op.drop_index('idx_kling_lip_sync_user_id', 'kling_lip_sync_tasks')

    # 删除表
    op.drop_table('kling_lip_sync_credits')
    op.drop_table('kling_lip_sync_tasks')
    op.drop_table('kling_lip_sync_config')
```

### 2. 迁移执行脚本

创建迁移执行脚本 `/backend/migrate_kling_lip_sync.py`：

```python
#!/usr/bin/env python3
"""
可灵对口型数据库迁移脚本
执行方式: python migrate_kling_lip_sync.py
"""

import os
import sys
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from alembic.config import Config
from alembic import command
import sqlite3
from datetime import datetime

def backup_database():
    """备份现有数据库"""
    db_path = "data/webui.db"
    if os.path.exists(db_path):
        backup_path = f"data/webui.db.lip_sync_migration_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        import shutil
        shutil.copy2(db_path, backup_path)
        print(f"✅ 数据库已备份到: {backup_path}")
        return backup_path
    return None

def check_migration_needed():
    """检查是否需要迁移"""
    db_path = "data/webui.db"
    if not os.path.exists(db_path):
        print("❌ 数据库文件不存在")
        return False

    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        # 检查表是否已存在
        cursor.execute("""
            SELECT name FROM sqlite_master
            WHERE type='table' AND name='kling_lip_sync_config'
        """)

        exists = cursor.fetchone() is not None
        conn.close()

        if exists:
            print("ℹ️  可灵对口型表已存在，无需迁移")
            return False
        else:
            print("🔄 需要执行可灵对口型迁移")
            return True

    except Exception as e:
        print(f"❌ 检查迁移状态失败: {e}")
        return False

def run_migration():
    """执行迁移"""
    try:
        # 设置Alembic配置
        alembic_cfg = Config("open_webui/alembic.ini")
        alembic_cfg.set_main_option("script_location", "open_webui/migrations")

        print("🔄 开始执行数据库迁移...")

        # 执行升级到最新版本
        command.upgrade(alembic_cfg, "head")

        print("✅ 数据库迁移完成!")

    except Exception as e:
        print(f"❌ 迁移失败: {e}")
        return False

    return True

def verify_migration():
    """验证迁移结果"""
    db_path = "data/webui.db"
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        # 验证表是否创建成功
        tables = ['kling_lip_sync_config', 'kling_lip_sync_tasks', 'kling_lip_sync_credits']

        for table in tables:
            cursor.execute(f"SELECT name FROM sqlite_master WHERE type='table' AND name='{table}'")
            if not cursor.fetchone():
                print(f"❌ 表 {table} 创建失败")
                conn.close()
                return False

        # 验证默认配置是否插入
        cursor.execute("SELECT COUNT(*) FROM kling_lip_sync_config")
        count = cursor.fetchone()[0]

        if count == 0:
            print("❌ 默认配置插入失败")
            conn.close()
            return False

        conn.close()
        print("✅ 迁移验证成功!")
        return True

    except Exception as e:
        print(f"❌ 验证失败: {e}")
        return False

def main():
    print("🚀 可灵对口型数据库迁移开始")
    print("=" * 50)

    # 1. 检查是否需要迁移
    if not check_migration_needed():
        print("✅ 迁移完成")
        return

    # 2. 备份数据库
    backup_path = backup_database()

    # 3. 执行迁移
    if not run_migration():
        print("❌ 迁移失败")
        if backup_path:
            print(f"💡 可以从备份恢复: {backup_path}")
        sys.exit(1)

    # 4. 验证迁移
    if not verify_migration():
        print("❌ 迁移验证失败")
        if backup_path:
            print(f"💡 可以从备份恢复: {backup_path}")
        sys.exit(1)

    print("=" * 50)
    print("🎉 可灵对口型功能迁移完成!")
    print("📌 下一步:")
    print("   1. 重启应用服务")
    print("   2. 登录管理员界面配置可灵对口型参数")
    print("   3. 测试对口型功能")

if __name__ == "__main__":
    main()
```

## 🚀 部署和测试方案

### 1. 开发环境部署步骤

```bash
# 1. 后端迁移
cd backend
python migrate_kling_lip_sync.py

# 2. 重启后端服务
python -m uvicorn open_webui.main:app --reload

# 3. 前端开发服务
cd ..
npm run dev
```

### 2. 功能测试清单

#### 管理员功能测试

- [ ] 可灵对口型配置页面访问正常
- [ ] 配置参数保存和加载功能
- [ ] API连接测试功能
- [ ] 积分设置生效

#### 用户功能测试

- [ ] 侧边栏对口型入口显示
- [ ] 对口型页面布局正常
- [ ] 文本转视频模式功能
- [ ] 音频转视频模式功能
- [ ] 任务提交和状态轮询
- [ ] 历史记录管理
- [ ] 积分扣费和退费机制

#### 集成测试

- [ ] 可灵API调用正常
- [ ] 文件上传和处理
- [ ] 云存储集成
- [ ] 错误处理和用户提示

### 3. 生产环境部署

```bash
# 1. 数据库备份
cp data/webui.db data/webui.db.backup_$(date +%Y%m%d_%H%M%S)

# 2. 执行迁移
python migrate_kling_lip_sync.py

# 3. 重启服务
systemctl restart wxiai-backend
systemctl restart wxiai-frontend
```

## 🎵 音色选项说明

### 中文音色分类 (35种)

**青少年音色**

- 阳光少年 (genshin_vindi2) - 充满活力的男孩音色
- 懂事小弟 (zhinen_xuesheng) - 成熟稳重的男学生音色
- 运动少年 (tiyuxi_xuedi) - 健康阳光的运动男孩
- 青春少女 (ai_shatang) - 甜美清新的女学生音色
- 温柔小妹 (genshin_klee2) - 温暖可爱的小女孩
- 元气少女 (genshin_kirara) - 活泼开朗的少女音色

**成年音色**

- 阳光男生 (ai_kaiya) - 成熟男性，声音明朗
- 幽默小哥 (tiexin_nanyou) - 幽默风趣的男性音色
- 文艺小哥 (ai_chenjiahao_712) - 温文尔雅的文艺男性
- 甜美邻家 (girlfriend_1_speech02) - 亲切自然的邻家女孩
- 温柔姐姐 (chat1_female_new-3) - 柔美温和的女性音色
- 职场女青 (girlfriend_2_speech02) - 干练知性的职场女性

**儿童音色**

- 活泼男童 (cartoon-boy-07) - 天真活泼的小男孩
- 俏皮女童 (cartoon-girl-01) - 可爱俏皮的小女孩
- 乖巧正太 (mengwa-v1) - 听话懂事的小男孩

**成熟音色**

- 稳重老爸 (ai_huangyaoshi_712) - 沉稳可靠的父亲音色
- 温柔妈妈 (you_pingjing) - 慈爱温暖的母亲音色
- 严肃上司 (ai_laoguowang_712) - 权威严肃的领导音色
- 优雅贵妇 (chengshu_jiejie) - 高贵典雅的女性音色

**老年音色**

- 慈祥爷爷 (zhuxi_speech02) - 慈祥和蔼的爷爷
- 唠叨爷爷 (uk_oldman3) - 话多的老爷爷
- 唠叨奶奶 (laopopo_speech02) - 爱唠叨的老奶奶
- 和蔼奶奶 (heainainai_speech02) - 温和慈祥的奶奶

**地域特色音色**

- 东北老铁 (dongbeilaotie_speech02) - 东北方言特色
- 重庆小伙 (chongqingxiaohuo_speech02) - 重庆方言特色
- 四川妹子 (chuanmeizi_speech02) - 四川方言特色
- 潮汕大叔 (chaoshandashu_speech02) - 潮汕方言特色
- 台湾男生 (ai_taiwan_man2_speech02) - 台湾腔调特色
- 西安掌柜 (xianzhanggui_speech02) - 西安方言特色
- 天津姐姐 (tianjinjiejie_speech02) - 天津方言特色

**专业音色**

- 新闻播报男 (diyinnansang_DB_CN_M_04-v2) - 专业播音员音色
- 译制片男 (yizhipiannan-v1) - 经典译制片配音
- 撒娇女友 (tianmeixuemei-v1) - 撒娇甜美的女友音色
- 刀片烟嗓 (daopianyansang-v1) - 独特的烟嗓质感

### 英文音色分类 (27种)

**青年音色**

- Sunny (genshin_vindi2) - 阳光开朗的男性
- Sage (zhinen_xuesheng) - 睿智沉稳的男性
- Ace (AOT) - 自信强势的男性
- Blossom (ai_shatang) - 花一样美丽的女性
- Peppy (genshin_klee2) - 活力充沛的女性
- Dove (genshin_kirara) - 温和如鸽子的女性

**成年专业音色**

- Shine (ai_kaiya) - 闪耀自信的男性
- Anchor (oversea_male1) - 主持人般的男性
- Lyric (ai_chenjiahao_712) - 富有诗意的男性
- Melody (girlfriend_4_speech02) - 悦耳如歌的女性
- Tender (chat1_female_new-3) - 温柔体贴的女性
- Siren (chat_0407_5-1) - 魅惑动人的女性

**儿童音色**

- Zippy (cartoon-boy-07) - 快速活泼的男童
- Bud (uk_boy1) - 如花苞般纯真的男孩
- Sprite (cartoon-girl-01) - 精灵般可爱的女童
- Candy (PeppaPig_platform) - 甜如糖果的女童

**成熟音色**

- Beacon (ai_huangzhong_712) - 如灯塔般稳重的男性
- Rock (ai_huangyaoshi_712) - 坚如磐石的男性
- Titan (ai_laoguowang_712) - 强大威严的男性
- Grace (chengshu_jiejie) - 优雅高贵的女性
- Helen (you_pingjing) - 经典美丽的女性

**特色音色**

- Lore (calm_story1) - 适合讲故事的平静音色
- Crag (uk_man2) - 粗犷豪放的男性
- Prattle (laopopo_speech02) - 爱唠叨的老妇人
- Hearth (heainainai_speech02) - 温暖如炉火的老奶奶
- The Reader (reader_en_m-v1) - 专业朗读者音色
- Commercial Lady (commercial_lady_en_f-v1) - 广告女声音色

### 音色使用建议

1. **语言一致性**：选择与对口型内容语言一致的音色
2. **角色匹配**：根据视频中的人物年龄、性格选择合适音色
3. **场景适配**：正式场合选择专业音色，日常场景选择亲切音色
4. **地域特色**：如需要方言效果，可选择对应地域特色音色

## 📊 性能和监控

### 1. 性能优化建议

- **API调用优化**：实施连接池和重试机制
- **文件处理优化**：大文件分块上传
- **缓存策略**：配置和任务状态缓存
- **数据库优化**：适当的索引和查询优化

### 2. 监控指标

- 可灵对口型任务成功率
- 平均处理时间
- API响应时间
- 积分消耗统计
- 用户使用频率

## 🔧 维护和扩展

### 1. 日常维护

- **日志监控**：关注API调用失败日志
- **积分核对**：定期核对积分扣费准确性
- **性能监控**：关注响应时间和成功率
- **用户反馈**：收集和处理用户体验反馈

### 2. 功能扩展空间

- **更多音色支持**：扩展可选音色库
- **批量处理**：支持批量对口型任务
- **模板管理**：常用配置模板保存
- **高级设置**：更多参数控制选项

## 📋 风险评估和应对

### 1. 技术风险

- **API不稳定**：实施重试机制和降级策略
- **存储空间**：监控存储使用量，设置清理策略
- **并发处理**：合理控制并发任务数量

### 2. 业务风险

- **成本控制**：设置合理的积分价格和用量限制
- **内容安全**：实施内容审核机制
- **用户体验**：提供清晰的使用指导

## 🎯 成功指标

### 1. 技术指标

- 功能可用性 > 99%
- API响应时间 < 2秒
- 任务成功率 > 95%

### 2. 用户指标

- 用户满意度 > 4.5/5
- 功能使用率 > 30%
- 用户留存率提升

---

## 📞 支持联系

如有任何技术问题或实施困难，请联系开发团队获得支持。

**实施状态**: ⏳ 待实施  
**预计工期**: 3-5个工作日  
**风险等级**: 🟡 中等（需要外部API集成）
